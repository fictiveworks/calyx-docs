<html>
  <head>
    <title>Code Example Component</title>
    <meta charset="utf-8">
    <link rel="stylesheet" href="example-grid.css">
    <link rel="stylesheet" href="example-component.css">
    <script src="https://unpkg.com/calyx@0.10.0/calyx.js"></script>
  </head>
  <body>


<script type="module">
import { html, render, nothing } from 'https://unpkg.com/lit-html/lit-html.js';
import { component, useState, useReducer } from 'https://unpkg.com/haunted/haunted.js';

function ExampleReady(runExample) {
  return html`<div class="example-ready">
    <button class="example-run" @click=${runExample}>
      <svg version="1.1" id="run-id" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" height="100px" width="100px"
         viewBox="0 0 100 100" enable-background="new 0 0 100 100" xml:space="preserve">
        <path class="stroke-solid" fill="none" stroke="white"  d="M49.9,2.5C23.6,2.8,2.1,24.4,2.5,50.4C2.9,76.5,24.7,98,50.3,97.5c26.4-0.6,47.4-21.8,47.2-47.7
          C97.3,23.7,75.7,2.3,49.9,2.5"/>
        <path class="icon" fill="white" d="M38,69c-1,0.5-1.8,0-1.8-1.1V32.1c0-1.1,0.8-1.6,1.8-1.1l34,18c1,0.5,1,1.4,0,1.9L38,69z"/>
      </svg>
    </button>
  </div>`;
}

const ResultView = {
  STRING: 0,
  OBJECT: 1
}

// const ExampleResult = virtual((state) => {
//   console.log("From child")
//   console.log(state)
//
//   // const markup = (state.mode == ResultView.STRING)
//   //   ? html`<p class="example-text">${state.result.text}</p>`
//   //   : html`<div class="example-inspector">${ExampleInspector(state.result)}</div>`;
//   //
//   // return html`<div class="example-result">
//   //   ${markup}
//   // </div>`;
//
//   return html`<div class="example-result">
//     Static text
//   </div>`;
// });

const initialState = {
  isReady: true,
  result: null,
  mode: ResultView.STRING
}

function outputReducer(state, action) {
  switch (action.type) {
    case "run":
      return { isReady: false, result: action.result, mode: state.mode };
    case "mode":
      return { isReady: false, result, mode: action.mode }
    case "reset":
      return initialState;
  }
}

function ExampleRun(state) {
  console.log(state.result.text)

  const markup = (state.mode == ResultView.STRING)
    ? html`<p class="example-text">${state.result.text}</p>`
    : html`<div class="example-inspector">${ExampleInspector(state.result)}</div>`;

  return html`<div class="example-result">
    ${markup}
  </div>`;
}

function ExampleConsole({ name }) {
  const [state, dispatch] = useReducer(outputReducer, initialState);

  const runExample = () => {
    const grammar = calyx.grammar({
      start: "{greeting} world",
      greeting: ["Hello", "Hi", "Hey", "Yo"]
    });
    const result = grammar.generate();
    dispatch({ type: "run", result });
  }

  const resetExample = () => dispatch({ type: "reset" });

  // This needs to go in as an effect
  const allScripts = Array.from(this.querySelectorAll("example-script"));

  console.log(allScripts)

  const selectedTab = "Ruby";

  return html`
  <article class="example">
    <div class="example-container">
      <header class="example-header">
        <ul class="example-tabs">
          ${allScripts.map(el => {
            const tab = el.getAttribute("tab");
            return html`
              <li><button role="tab" ?aria-selected=${tab == selectedTab}>${tab}</button></li>
            `;
          })}
        </ul>
      </header>
      <slot></slot>
      <footer class="example-footer">
        <ul class="example-tabs">
          <li><button role="button" id="copy-button">Copy</button></li>
        </ul>
      </footer>
    </div>
    <div class="example-output">
      <header class="example-header">
        <ul class="example-tabs">
          <li><button role="tab" aria-selected="true">String</button></li>
          <li><button role="tab" aria-selected="false">Result</button></li>
        </ul>
      </header>
      ${state.isReady ? ExampleReady(runExample) : ExampleRun(state)}
      <footer class="example-footer">
        <ul class="example-tabs">
          ${!state.isReady ?
            html`<li><button role="button" @click=${runExample}>Repeat</button></li>
                 <li><button role="button" @click=${resetExample}>Reset</button></li>`
            : nothing}
        </ul>
      </footer>
    </div>
  </article>
  `;
}

customElements.define("example-console", component(ExampleConsole, {
  observedAttributes: ["name"],
  useShadowDOM: false
}));

function ExampleScript({ slot, tab, selected }) {
  const selectedAttr = selected ? "true" : "false";
  return html`
    <div class="example-code" aria-selected=${selectedAttr} id=${tab.toLowerCase()}>
      <slot name="script"></slot>
    </div>
  `;
}

customElements.define("example-script", component(ExampleScript, {
  observedAttributes: ["slot", "tab", "selected"]
}));

</script>

<main>
  <example-console id="tutorial1">
    <example-script slot="script" tab="Ruby">
      <pre><code>grammar = Calyx::Grammar.new do
start '{greeting} world.'
greeting 'Hello', 'Hi', 'Hey', 'Yo'
end

grammar.generate</code></pre>
    </example-script>
    <example-script slot="script" tab="JavaScript">
      <pre><code>const grammar = calyx.grammar({
"start": ["One", "Two", "Three"]
});

grammar.generate()</code></pre>
    </example-script>
    <example-script slot="script" tab="JSON" selected>
      <pre>
        <code>{
          "start": ["One", "Two", "Three"]
        }
        </code>
      </pre>
    </example-script>
  </example-console>
</main>

</body>
</html>
